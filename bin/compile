#!/bin/bash

set -e # exit when any command fails

BASE_DIR=$(git rev-parse --show-toplevel)
TMP_DIR="$BASE_DIR/.tmp_build"
BUILDS_DIR="$BASE_DIR/builds"
BIN_DIR="$BASE_DIR/node_modules/.bin"

TARGET="node8.9.0"
PATHS=(
  "bin" "src" "starter" "themes"
  "package.json" "yarn.lock"
)

rm -rf $TMP_DIR
mkdir $TMP_DIR

for path in "${PATHS[@]}"
do
  cp -r $BASE_DIR/$path $TMP_DIR
done

cd $TMP_DIR
yarn install --production
yarn link @timberio/ui

$BIN_DIR/pkg . \
  --out-path $BUILDS_DIR \
  --targets $TARGET-macos
  # --targets $TARGET-macos,$TARGET-linux,$TARGET-win

rm -rf $TMP_DIR
